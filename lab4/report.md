# 实验3 综合实验报告：页表与内存管理

## 一、系统设计部分

### 1. 架构设计说明
- 物理内存分配器采用单链表管理空闲页，接口简洁，易于扩展。
- 页表管理实现了Sv39三级页表递归遍历与映射，支持权限控制。
- 虚拟内存激活流程严格遵循RISC-V规范，支持内核空间映射与设备映射。

### 2. 关键数据结构
- struct run：物理页链表节点
- pagetable_t/pte_t：页表与页表项类型
- freelist：空闲页链表头指针

### 3. 与xv6对比分析
- 物理内存分配器结构与xv6类似，但接口更简洁，便于统计和调试。
- 页表管理接口更清晰，便于后续扩展用户进程支持。

### 4. 设计决策理由
- 采用链表分配器，便于实现和调试，适合教学实验。
- 页表递归遍历，代码简洁，易于理解。

## 二、实验过程部分

### 1. 实现步骤记录
- 物理内存分配器(pmm.c/h)：实现初始化、分配、释放、统计接口
- 页表管理(vm.c/h)：实现walk/map/destroy/dump等功能
- 虚拟内存激活(vm_boot.c)：实现kvminit/kvminithart
- main.c：插入各阶段测试代码

### 2. 问题与解决方案
- **问题**：页表映射失败/权限错误
  - **解决**：增加对齐检查、调试输出，完善walk_create
- **问题**：内存分配后未释放导致统计异常
  - **解决**：补充free_page和destroy_pagetable调用

### 3. 源码理解总结
- Sv39三级页表的每级索引提取、PTE格式、权限位设置
- 物理内存分配器链表结构的高效性与局限性

## 三、测试验证部分

### 1. 功能测试结果
- 物理内存分配/释放、页表映射/查找/销毁均通过main.c测试
- 分页激活前后内核功能正常，串口输出无异常

### 2. 性能数据
- 分配/释放单页操作O(1)，页表遍历O(1)~O(3)
- 空闲页统计接口可实时反映内存使用

### 3. 异常测试
- 多次释放同一页、越界映射等均能正确处理或报错

### 4. 运行截图/录屏，考题回答
- （此处插入测试输出截图/录屏）

#### 设计对比
- 与xv6相比，本实验分配器接口更简洁，便于统计和调试。
- 选择链表方案，权衡了实现复杂度与实验需求。

#### 内存安全
- 通过对齐检查、空指针检查、权限位严格设置，防止恶意利用。
- 页表权限严格区分内核/用户空间。

#### 性能分析
- 性能瓶颈主要在链表遍历和页表递归，适合教学实验。
- 可通过统计接口和测试代码测量内存分配/释放性能。

#### 扩展性
- 若支持用户进程，可为每个进程分配独立页表，复用现有接口。
- 实现内存共享/写时复制需增加引用计数和只读保护。

#### 错误恢复
- 页表创建失败时，destroy_pagetable递归释放已分配资源。
- 通过pmm_free_pages等接口检测内存泄漏。

---
