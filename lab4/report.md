# 实验4 综合实验报告：中断处理与时钟管理


## 一、系统设计部分

### 1. 架构设计说明
- trap.c 实现了中断/异常统一入口，支持时钟、UART、非法指令等处理。
- timer.c 实现了时钟中断管理与计数。
- main.c 集成了各类中断与异常测试，便于验证功能。
- 页表与内存管理沿用上次实验，支持中断/异常下的安全访问。


### 2. 关键数据结构
- trapframe 结构体：保存中断/异常现场。
- interrupt_count：中断计数器。
- timer 相关变量：时钟计数与管理。


### 3. 与xv6对比分析
- trap/中断处理流程与 xv6 类似，但异常处理和时钟管理接口更清晰，便于调试和扩展。


### 4. 设计决策理由
- trap 统一入口便于扩展多种中断类型。
- sepc 跳转逻辑可灵活处理异常和指令跳过。


## 二、实验过程部分

### 1. 实现步骤记录
- trap.c/h：实现 trapvec 设置、中断/异常分发、sepc 跳转。
- timer.c/h：实现时钟初始化、中断计数。
- main.c：插入 trapinithart、test_timer_interrupt、test_exception_handling、test_interrupt_overhead 等测试代码。


### 2. 问题与解决方案
- **问题**：中断不触发/无响应
  - **解决**：检查 trapvec 映射、中断使能、trap handler 注册。
- **问题**：时钟计数异常
  - **解决**：检查 timer 初始化和中断使能。
- **问题**：异常处理卡死
  - **解决**：完善 sepc 跳转逻辑，调试输出异常信息。


### 3. 源码理解总结
- trap 入口与分发机制，sepc 跳转与异常恢复。
- timer 中断流程与计数实现。


## 三、测试验证部分

### 1. 功能测试结果
- trapinithart、test_timer_interrupt、test_exception_handling、test_interrupt_overhead 等测试均通过 main.c 验证。
- 启用分页后内核功能正常，串口输出可见中断计数、异常信息、时钟响应。


### 2. 性能数据
- 时钟中断响应延迟低，计数准确。
- 异常处理可正确跳过非法指令。


### 3. 异常测试
- 非法指令异常可通过 sepc 跳转跳过。
- 时钟中断可持续计数，异常处理流程健壮。


### 4. 运行截图/录屏，考题回答
- （此处插入中断计数、异常处理、时钟响应等测试输出截图/录屏）

#### 设计对比
- trap/中断处理流程更清晰，时钟管理易于扩展。

#### 安全与健壮性
- sepc 跳转防止异常卡死，trapframe 保护现场。

#### 性能分析
- 时钟中断响应及时，异常处理无明显性能瓶颈。

#### 扩展性
- 可扩展更多中断类型和调度策略。

#### 错误恢复
- trap handler 可输出调试信息，便于定位问题。
